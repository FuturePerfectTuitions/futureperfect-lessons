<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Future Perfect – Choose Year</title>

  <style>
    :root{
      --red:#d71920;
      --blue:#0b2a6f;
      --border:#e5e5e5;
      --text:#111;
      --muted:#666;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:24px;
      font-family:"Segoe UI",Arial,sans-serif;
      color:var(--text);
      background:#fff;
    }
    .frame{
      max-width:1000px;
      margin:0 auto;
      padding:10px;
      border-radius:22px;
      background:repeating-linear-gradient(
        45deg,
        var(--red) 0 14px,
        #fff 14px 28px,
        var(--blue) 28px 42px,
        #fff 42px 56px
      );
    }
    .panel{
      background:#fff;
      border-radius:16px;
      padding:18px;
      border:1px solid var(--border);
    }
    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom:14px;
    }
    .logo{
      height:46px;
      width:auto;
    }
    h1{
      font-size:22px;
      margin:0;
    }
    .muted{ color:var(--muted); font-size:14px; margin-top:4px; }
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:12px;
      margin-top:16px;
    }
    .btn{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:600;
      text-decoration:none;
      color:var(--text);
    }
    .btn:hover{ border-color:#cfcfcf; }
    .error{
      margin-top:14px;
      padding:12px;
      border:1px solid #f1c1c1;
      background:#fff5f5;
      border-radius:12px;
      color:#7a0b0b;
      display:none;
      white-space:pre-wrap;
    }
  </style>
</head>

<body>
  <div class="frame">
    <div class="panel">
      <div class="top">
        <div>
          <h1>Choose your year</h1>
          <div class="muted" id="sub">Loading your access…</div>
        </div>
        <img class="logo" src="assets/fpt-logo.png" alt="Future Perfect Tuitions">
      </div>

      <div class="grid" id="years"></div>
      <div class="error" id="err"></div>
    </div>
  </div>

<script>
  const API = "https://fpt-lessons-api.futureperfectlessons.workers.dev";

  function showError(msg){
    const el = document.getElementById("err");
    el.style.display = "block";
    el.textContent = msg;
  }

  function getAuth(){
    const u = (sessionStorage.getItem("fpt_u") || "").trim();
    const p = (sessionStorage.getItem("fpt_p") || "").trim();
    if(!u || !p) return null;
    return { u, p, header: "Basic " + btoa(u + ":" + p) };
  }

  async function run(){
    const auth = getAuth();
    if(!auth){
      location.href = "index.html";
      return;
    }

    const res = await fetch(`${API}/years`, {
      method: "GET",
      headers: { "Authorization": auth.header }
    });

    if(!res.ok){
      showError(`Failed to load years (${res.status})`);
      document.getElementById("sub").textContent = "Could not load access.";
      if (res.status === 401) {
        sessionStorage.removeItem("fpt_u");
        sessionStorage.removeItem("fpt_p");
        setTimeout(() => location.href = "index.html", 600);
      }
      return;
    }

    const years = await res.json();
    document.getElementById("sub").textContent = `Access granted: ${years.join(", ") || "none"}`;

    const wrap = document.getElementById("years");
    wrap.innerHTML = "";

    if(!years.length){
      showError("This user has no years assigned.");
      return;
    }

    for(const y of years){
      const a = document.createElement("a");
      a.className = "btn";
      a.href = `lessons.html?year=${encodeURIComponent(y)}`;
      a.textContent = y;
      wrap.appendChild(a);
    }
  }

  run().catch(err => showError(String(err)));
</script>
</body>
</html>
